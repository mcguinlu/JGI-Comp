---
title: Does the movement of students to a different region of England for education associate with increased lonliness
  in their county of origin?
output:
  pdf_document:
    toc: true
    number_sections: true
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(scales)
```

# Research question

In addition to our general visualsiation of the datasets provided by the JGI Data Competition and others sourced online, we wanted to explore the hypothesis that students leaving their county to travel to a different region of the country for higher education might be associated with the lonliness score in at county.

We choose this question because we believe the effect of student migration on those left behind is often overlooked in terms of analysis/interventions. 

*** 

# Datasets

The datasets used in this analysis are laid out below. For familiarity, the first few rows of each datasets are presented.

<br>

## NSO Lonliness Score {#lonliness-score-data}
Sourced from the JGI Data Competition team.

```{r, echo =FALSE}
data.lonliness <- read.csv("data/msoa_loneliness.csv")
colnames(data.lonliness)[1] <- "msoa11cd"
knitr::kable(head(data.lonliness))
```

<br>

## Student migration for education dataset {#student-migration-data}
Sourced from the [HESA website](https://www.hesa.ac.uk/data-and-analysis/students/where-from), this dataset describes the number of students moving to each region from a given domicile/town.

```{r, echo =FALSE}
data.move <- read.csv("data/Movement data.csv", header = FALSE)

# Remove description of dataset
data.move <- data.move[18:nrow(data.move),]

# Add first row to column headers and delete first row
colnames(data.move) = make.names(as.character(unlist(data.move[1, ])))
data.move = data.move[-1, ]

knitr::kable(head(data.move))
```

<br>

## Town/County/County List {#town-county-data}
Sourced from [here](https://www.paulstenning.com/uk-towns-and-counties-list/), this dataset matches town names to their respective counties and countries.

```{r, echo =FALSE}
town.county <- read.csv("data/Towns_List.csv")
knitr::kable(head(town.county))
```

<br>

## County/Region List {#county-region-data}
Sourced from [here](https://wiki.freecycle.org/UK_Counties_and_Regions), this dataset matches counties to their respective regions.

```{r, echo =FALSE}
county.region <- read.csv("data/county.region.csv", stringsAsFactors=FALSE, header = TRUE)
colnames(county.region)[1] <- "County"
knitr::kable(head(county.region))
```

<br>

***

<br>

# Analysis
## Create the combined towns, counties and regions dataset

To create a single dataset which matched towns to their respective counties and regions, we merged datasets [3](#town-county-data) & [4](#county-region-data).

```{r town.county.region list, e}
# Import town.county list, and limit to towns in England
town.county <- read.csv("data/Towns_List.csv")
town.county <- town.county[which(town.county$Country=="England"),]
town.county <- town.county[,c(1:2)]

# Import county.region list
county.region <- read.csv("data/county.region.csv", stringsAsFactors=FALSE, header = TRUE)
colnames(county.region)[1] <- "County"

# Merge above datasets on the basis of county to create town.county.region data 
town.county.region <- merge(town.county, county.region)
```

```{r, echo = FALSE}
town.county.region.head <- town.county.region[,c(2,1,3)]

knitr::kable(head(town.county.region.head), caption = "Top six rows of the town.county.region dataset")
```


## Preparation for migration analysis

In order to 

```{r}
# Read in HESA student migration
data.move <- read.csv("data/Movement data.csv", header = FALSE)

# Clean dataframe of description and correct column names
data.move <- data.move[18:nrow(data.move),]
colnames(data.move) = make.names(as.character(unlist(data.move[1, ])))
data.move = data.move[-1, ]
data.move <- as_tibble(data.move)

# Remove "City of" from Domicile column to aid merging
data.move <- data.move %>%
  mutate(Domicile = gsub("City of ", "", Domicile))

# Merge on basis of county name
tmp1 <- merge(data.move, county.region, by.x = "Domicile", by.y = "County")
colnames(tmp1)[1] <- "County"

# Merge on basis on town name
tmp2 <- merge(data.move, town.county.region, by.x = "Domicile", by.y = "Town")
tmp2 <- tmp2[,c(2:9)]

# Combine the two merged datasets created above
countydata <- rbind(tmp1, tmp2)
```

```{r, echo = FALSE}
countydata.head <- countydata[,c(1,8,5,3,4,6,7)]
knitr::kable(head(countydata.head), caption = "Top six rows of the movement for education dataset, with additional information on county/region of origin")
```

## Matching dates

We ran into issues around how to convert the academic year (used in the student migration [data](#student-migration-data) ) to the calendar year (used in the lonliness index [data](#lonliness-score-data)).

We decided to assign the full effect of a given academic year to it's earliest calendar year, on the basis that the effect of student migration on lonliness is likely to be most acute in the months immediately after their departure. For example, the 2014/2015 academic year was recoded as 2014.

``` {r}
countydata <- countydata %>%
  mutate(
  Academic.Year = gsub("2014/15", "2014", Academic.Year),
  Academic.Year = gsub("2015/16", "2015", Academic.Year),
  Academic.Year = gsub("2016/17", "2016", Academic.Year),
  Academic.Year = gsub("2017/18", "2017", Academic.Year)
  )

```

## Number of students leaving their county for university

In keeping with our research question, to prepare the dataset to examine the effect on lonelinenss within a county of students moving out of the country to study, we:
  * Removed the totals rows to prevent double counting
  * Removed students enrolled in The Open university, as this is primarily a distance learning insitution, and so students would not have to travel to attend this institution. 
  * Removed students those whose institution was in the same region which they came from. This was used as a proxy for a substantial distance between home county and university.

```{r}
# Students moving from domicile ################################################
countydata.trimmed.out <- filter(
  countydata,
  Region.of.HE.provider != "Total England" &
  Region.of.HE.provider != "Total United Kingdom" &
  Region.of.HE.provider != "The Open University in England" &
  Region.of.HE.provider != Region
  )
```


We then summed all those leaving their county to attend a university in a different region of the UK. from a certain area to create an outward migration for education statistic. The plot below shows the results of this analysis for 2017.

Note: the plot below shows 47 of the 48 counties in England. We limited the analysis to England as we only had lonliness data for this country. Further, the City of London is not shown below, as it was included as part of Greater London in the student migration data.

We filtered the data to correspond to the most general cases (e.g. include all levels of study and all modes of study)

``` {r fig1, fig.height = 10}

# Create sum of people moving from each domicile 
data.outof.domicile <- filter(countydata.trimmed.out, X4.way.domicile == "All", Level.of.study == "All", Mode.of.study == "All") %>%
  group_by(Academic.Year, County) %>%
  summarise(sum.no = sum(as.numeric(as.character(Number))))

fig1.data <- data.outof.domicile[which(data.outof.domicile$Academic.Year=="2017"),]

ggplot(fig1.data, aes(x = fct_rev(County), y=sum.no)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "County (England only)",
       y = "Total number of students moving from this county", 
       title = "Movement of students for education in September 2017") +
  scale_y_continuous(breaks=seq(0, 175000, 25000),label = scales::comma, expand=c(0,0))+
  expand_limits(y=150000) +
  theme(plot.margin = unit(c(1,1,1,1), "cm"))
```



## Total change in population due to migration for education

In addition to the above analysis we decide to examine the effect of total migration for education (number of students leaving the region + number of students arriving in the region) on lonliness on that region.

We created a summative rather than net migration for education per region figure on the basis that having students moving into a region is more likely to increase lonliness (as they may be homesick) than reduce it, as they will not keep up the social contacts that the students who left had, plus they might possibly be homesick/lonely themselves.

### From a region
```{r}
# Building on the intital analysis done above
data.outof.region <- filter(countydata.trimmed.out, X4.way.domicile == "All", Level.of.study == "All", Mode.of.study == "All") %>%
  group_by(Academic.Year, Region) %>%
  summarise(no.out = sum(as.numeric(as.character(Number))))

ggplot(data.outof.region, aes(x = fct_rev(Region), y=no.out)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "Region (limited to England)",
       y = "Total number of students moving from this region")
```


### Into a region
```{r}
#Limit dataset to those travelling to HE provider within England
countydata.trimmed.in <- filter(
  countydata,
  Region.of.HE.provider == "West Midlands" |
    Region.of.HE.provider == "Yorkshire and the Humber" |
    Region.of.HE.provider == "South West" |
    Region.of.HE.provider == "South East" |
    Region.of.HE.provider == "North West" |
    Region.of.HE.provider == "North East" |
    Region.of.HE.provider == "London" |
    Region.of.HE.provider == "East of England"|
    Region.of.HE.provider == "East Midlands"
)

# Create sum of people moving into each region of England
data.into.region <- filter(countydata.trimmed.in, X4.way.domicile == "All", Level.of.study == "All", Mode.of.study == "All") %>%
  group_by(Academic.Year, Region) %>%
  summarise(no.in = sum(as.numeric(as.character(Number))))

fig2.data.1 <- data.into.region[which(data.into.region$Academic.Year=="2017"),]
fig2.data.1[4] <- "In"
colnames(fig2.data.1)[4] <- "Direction"
colnames(fig2.data.1)[3] <- "No"
fig2.data.2 <- data.outof.region[which(data.outof.region$Academic.Year=="2017"),]
fig2.data.2[4] <- "Out"
colnames(fig2.data.2)[4] <- "Direction"
colnames(fig2.data.2)[3] <- "No"

fig2.data <- rbind(fig2.data.1,fig2.data.2)


# Plot results
ggplot(fig2.data, aes(x = fct_rev(Region), y= No, fill = Direction)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "Region of HE provider (limited to England)",
       y = "Total number of students moving to this region")
```

### Combine in/out migration numbers
```{r}
data.sum.migration <- merge(data.into.region,data.outof.region)

data.sum.migration <- data.sum.migration %>%
  mutate(no.total = no.in + no.out)
```




``` {r}

data.lonliness <- read.csv("data/msoa_loneliness.csv")

data.lonliness <- data.lonliness %>%
  mutate(District = gsub('[[:digit:]]+', '', msoa11nm),
         District = gsub(" $","", District, perl=T))


# Add County Level
district.county <- read.csv("data/district-county.csv")
colnames(district.county)[1] <- "District"

data.lonliness <- merge(data.lonliness,district.county,by="District",all.x=TRUE)

data.lonliness$County <- as.character(data.lonliness$County)

data.lonliness$County <- ifelse(is.na(data.lonliness$County) == TRUE,"0", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Bournemouth", "Dorset", data.lonliness$County)
                           
data.lonliness$County <- ifelse(data.lonliness$District == "Poole", "Dorset", data.lonliness$County)  

data.lonliness$County <- ifelse(data.lonliness$District == "Christchurch", "Dorset", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "East Dorset", "Dorset", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "West Dorset", "Dorset", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "North Dorset", "Dorset", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Purbeck", "Dorset", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Shepway", "Kent", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "St Edmundsbury", "West Suffolk", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "St. Helens", "Merseyside", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Forest Heath", "West Suffolk", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Suffolk Coastal", "East Suffolk", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Waveney", "East Suffolk", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Taunton Deane", "Somerset West and Taunton", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "West Somerset", "Somerset West and Taunton", data.lonliness$County)

data.lonliness$County <- ifelse(data.lonliness$District == "Weymouth and Portland", "Dorset", data.lonliness$County)

# Add Region
county.region <- read.csv("data/county.region.csv")
colnames(county.region)[1] <- "County"

data.lonliness <- merge(data.lonliness, county.region, by="County",all.x=TRUE)

```


## Association of number of students leaving county and mean loneliness score for that county
``` {r}

# Summarise by county
mean.lonliness.county <- data.lonliness %>%
  group_by(County) %>%
  summarise("2016" = mean(loneills_2016),
            "2017" = mean(loneills_2017),
            "2018" = mean(loneills_2018))

mean.lonliness.county <- gather(mean.lonliness.county, Academic.Year, mean.score, "2016","2017","2018", factor_key = FALSE)

# Merge with movement data
move.lonliness.county <- merge(mean.lonliness.county,data.outof.domicile)

move.lonliness.county.2016 <- move.lonliness.county[which(move.lonliness.county$Academic.Year=="2016"),]

ggplot(move.lonliness.county.2016, aes(x=sum.no,y=mean.score))+
  geom_point() +
  geom_smooth(method='lm')
  
cor(move.lonliness.county.2016$mean.score, move.lonliness.county.2016$sum.no)

linearMod <- lm(mean.score ~ sum.no, data=move.lonliness.county.2016)
print(linearMod) 
summary(linearMod)

```

## Association of number of students leaving region (England only) and mean loneliness score for that region
```{r}
# Summarise by Region
mean.lonliness.region <- data.lonliness %>%
  group_by(Region) %>%
  summarise("2016" = mean(loneills_2016),
            "2017" = mean(loneills_2017),
            "2018" = mean(loneills_2018))

mean.lonliness.region <- gather(mean.lonliness.region, Academic.Year, mean.score, "2016","2017","2018", factor_key = FALSE)

# Merge with movement data
move.lonliness.region <- merge(mean.lonliness.region,data.outof.region)

move.lonliness.region.2016 <- move.lonliness.region[which(move.lonliness.region$Academic.Year=="2016"),]

ggplot(move.lonliness.region.2016, aes(x=no.out,y=mean.score))+
  geom_point() +
  geom_smooth(method='lm')
  
cor(move.lonliness.region.2016$mean.score, move.lonliness.region.2016$no.out)

linearMod <- lm(mean.score ~ no.out, data=move.lonliness.region.2016)
summary(linearMod)

```

## Association of change in student population (total number leacing region plus total number moving to region) and mean loneliness score for that region

```{r}
data.sum.migration.2016 <- data.sum.migration[,c(1,2,5)]
data.sum.migration.2016 <- data.sum.migration.2016[which(data.sum.migration.2016$Academic.Year==2016),]

move.lonliness.region.2016 <- move.lonliness.region.2016[,c(1:3)]

total.move.lonliness.region.2016 <- merge(data.sum.migration.2016,move.lonliness.region.2016)

cor(total.move.lonliness.region.2016$mean.score, total.move.lonliness.region.2016$no.total)

ggplot(total.move.lonliness.region.2016, aes(x=no.total,y=mean.score))+
  geom_point() +
  geom_smooth(method='lm')

linearMod <- lm(mean.score ~ no.total, data=total.move.lonliness.region.2016)
summary(linearMod)
```























